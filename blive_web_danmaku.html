<!DOCTYPE html>
<html>

<head>
    <title>YuiWeb弹幕</title>
    <link id="danmaku-style-link" rel="stylesheet" type="text/css" href="/blive_web_danmaku_style.css">
</head>

<body>
<div id="danmaku-container"></div>
<script>
    let httpPort = window.location.port;

    function connectWebSocket(port) {
        let ws = new WebSocket("ws://localhost:" + port);
        ws.onopen = function () {
            try {
                console.log("WebSocket 连接已打开");

            } catch (error) {
                console.error("处理WebSocket连接成功时发生错误:", error);
            }
        };
        ws.onerror = function (error) {
            console.error("WebSocket 连接遇到错误:", error);
        };
        ws.onmessage = function (event) {
            try {
                let message = event.data;
                try {
                    message = JSON.parse(message); // 尝试将消息解析为JSON对象
                } catch (error) {
                    // 如果消息不是JSON格式，假定它是普通文本消息
                    console.log("Received non-JSON message:", message);
                    let container = document.getElementById("danmaku-container");
                    let div = document.createElement("div");
                    div.classList.add("danmaku");
                    div.textContent = message;
                    container.appendChild(div);
                    return; // 处理完非JSON消息后直接返回
                }
                // 检查消息类型并执行相应操作
                if (message.type === "updateStyle") {
                    let newStyleLink = message.newStyle + "?t=" + new Date().getTime();
                    document.getElementById("danmaku-style-link").href = newStyleLink;
                } else if (message.danmaku) {
                    let danmakuData = message.danmaku;
                    let parts = danmakuData.split(", ");
                    let container = document.getElementById("danmaku-container");
                    let danmakuDiv = document.createElement("div");
                    danmakuDiv.classList.add("danmaku");

                    parts.forEach(function (part) {
                        var keyValue = part.split(": ");
                        var key = keyValue[0].trim();
                        var value = keyValue[1].trim();

                        var span = document.createElement("span");
                        span.classList.add(key.replace('.', '-')); // 将点替换为连字符
                        span.textContent = value;
                        danmakuDiv.appendChild(span);
                    });

                    container.appendChild(danmakuDiv);
                }
            } catch (error) {
                console.error("WebSocket消息处理错误:", error);
            }
        };
    }

    // 当页面加载完毕时，从服务器获取WebSocket端口并建立连接
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/ws-port')
            .then(response => response.json())
            .then(data => {
                connectWebSocket(data.ws_port);
            })
            .catch(error => console.error('Error fetching WebSocket port:', error));
    });
</script>
</body>

</html>
